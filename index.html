<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="LIFF åœ–ç‰‡é¸æ“‡æ‡‰ç”¨ç¨‹å¼ - æ”¯æ´ LINE ç™»å…¥å’Œåœ–ç‰‡é¸æ“‡åŠŸèƒ½" />
  <meta name="keywords" content="LIFF, LINE, åœ–ç‰‡é¸æ“‡, ç›¸æ©Ÿ, ç›¸ç°¿" />
  <meta name="author" content="LIFF App Developer" />
  
  <!-- Open Graph Meta Tags for better sharing -->
  <meta property="og:title" content="LIFF åœ–ç‰‡é¸æ“‡æ‡‰ç”¨ç¨‹å¼" />
  <meta property="og:description" content="æ”¯æ´ LINE ç™»å…¥å’Œåœ–ç‰‡é¸æ“‡åŠŸèƒ½çš„ LIFF æ‡‰ç”¨ç¨‹å¼" />
  <meta property="og:type" content="website" />
  
  <title>LIFF åœ–ç‰‡é¸æ“‡æ‡‰ç”¨ç¨‹å¼</title>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2.27.0/sdk.js"></script>
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“·</text></svg>" />
  
  <style>
    :root {
      --line-green: #00C300;
      --line-green-dark: #00A300;
      --line-green-light: #06C755;
      --success-bg: #d4edda;
      --success-text: #155724;
      --error-bg: #f8d7da;
      --error-text: #721c24;
      --warning-bg: #fff3cd;
      --warning-text: #856404;
      --info-bg: #d1ecf1;
      --info-text: #0c5460;
      --border-color: #e0e0e0;
      --shadow: 0 2px 10px rgba(0,0,0,0.1);
      --border-radius: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--line-green), var(--line-green-light));
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
      font-size: 2rem;
      font-weight: 600;
    }

    .status {
      padding: 12px 16px;
      margin: 12px 0;
      border-radius: var(--border-radius);
      font-weight: 500;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .success { 
      background-color: var(--success-bg); 
      color: var(--success-text);
      border-left-color: var(--success-text);
    }
    .error { 
      background-color: var(--error-bg); 
      color: var(--error-text);
      border-left-color: var(--error-text);
    }
    .warning { 
      background-color: var(--warning-bg); 
      color: var(--warning-text);
      border-left-color: var(--warning-text);
    }
    .info { 
      background-color: var(--info-bg); 
      color: var(--info-text);
      border-left-color: var(--info-text);
    }

    button {
      padding: 12px 24px;
      font-size: 16px;
      background-color: var(--line-green);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      margin: 8px 4px;
      transition: all 0.3s ease;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      opacity: 0.6;
    }

    button:hover:not(:disabled) {
      background-color: var(--line-green-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,195,0,0.3);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
    }

    .login-btn {
      background: linear-gradient(135deg, var(--line-green-light), var(--line-green));
      font-size: 18px;
      padding: 16px 32px;
      border-radius: 25px;
      box-shadow: 0 4px 15px rgba(6,199,85,0.3);
    }

    .login-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--line-green), var(--line-green-dark));
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(6,199,85,0.4);
    }

    #userInfo {
      background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
      padding: 20px;
      border-radius: var(--border-radius);
      margin: 20px 0;
      border-left: 4px solid var(--line-green);
      box-shadow: 0 2px 8px rgba(0,195,0,0.1);
    }

    #userInfo img {
      border-radius: 50%;
      margin-right: 15px;
      vertical-align: middle;
      border: 3px solid var(--line-green);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #preview {
      max-width: 100%;
      border: 3px solid #ddd;
      border-radius: var(--border-radius);
      margin-top: 15px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    #preview:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    #debug {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 20px;
      font-family: 'Courier New', Consolas, monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      line-height: 1.4;
    }

    .section {
      margin: 25px 0;
      padding: 20px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      background: #fafafa;
      transition: all 0.3s ease;
    }

    .section:hover {
      background: #f5f5f5;
      border-color: var(--line-green);
    }

    .section h3 {
      margin-top: 0;
      color: #333;
      font-size: 1.3rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .hidden {
      display: none;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--line-green);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .environment-info {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: var(--border-radius);
      padding: 15px;
      margin: 15px 0;
      font-size: 14px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 20px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        margin: 5px 0;
      }
    }

    /* ç„¡éšœç¤™æ”¹å–„ */
    button:focus {
      outline: 2px solid var(--line-green);
      outline-offset: 2px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“· LIFF åœ–ç‰‡é¸æ“‡æ‡‰ç”¨ç¨‹å¼</h1>
    
    <div id="status-container" role="status" aria-live="polite"></div>
    
    <!-- ç’°å¢ƒè³‡è¨Š -->
    <div id="environmentInfo" class="environment-info hidden">
      <strong>ğŸŒ ç’°å¢ƒè³‡è¨Šï¼š</strong>
      <span id="envDetails"></span>
    </div>
    
    <!-- ç™»å…¥å€åŸŸ -->
    <div id="loginSection" class="section">
      <h3>ğŸ”‘ LINE ç™»å…¥</h3>
      <p>è«‹å…ˆç™»å…¥æ‚¨çš„ LINE å¸³è™Ÿä»¥ä½¿ç”¨åœ–ç‰‡é¸æ“‡åŠŸèƒ½</p>
      <button id="loginBtn" class="login-btn" aria-describedby="loginHelp">
        <span id="loginBtnText">ğŸ”‘ ä½¿ç”¨ LINE ç™»å…¥</span>
      </button>
      <div id="loginHelp" class="sr-only">é»æ“Šæ­¤æŒ‰éˆ•å°‡è·³è½‰åˆ° LINE ç™»å…¥é é¢</div>
      <div id="userInfo" class="hidden" role="region" aria-label="ç”¨æˆ¶è³‡è¨Š"></div>
    </div>
    
    <!-- åŠŸèƒ½å€åŸŸ -->
    <div id="functionSection" class="section hidden">
      <h3>ğŸ“· åœ–ç‰‡é¸æ“‡åŠŸèƒ½</h3>
      <p>é¸æ“‡åœ–ç‰‡ä¾†æºï¼šç›¸æ©Ÿæ‹ç…§æˆ–å¾ç›¸ç°¿é¸æ“‡</p>
      <div class="button-group">
        <button id="chooseBtn" onclick="chooseMedia()" disabled aria-describedby="chooseBtnHelp">
          <span id="chooseBtnText">é¸æ“‡åœ–ç‰‡</span>
        </button>
        <button onclick="checkLiffStatus()" aria-describedby="statusHelp">æª¢æŸ¥ LIFF ç‹€æ…‹</button>
        <button onclick="logout()" aria-describedby="logoutHelp">ç™»å‡º</button>
      </div>
      <div id="chooseBtnHelp" class="sr-only">é¸æ“‡åœ–ç‰‡åŠŸèƒ½éœ€è¦åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨</div>
      <div id="statusHelp" class="sr-only">æª¢æŸ¥ LIFF æ‡‰ç”¨ç¨‹å¼çš„ç•¶å‰ç‹€æ…‹</div>
      <div id="logoutHelp" class="sr-only">ç™»å‡ºç•¶å‰çš„ LINE å¸³è™Ÿ</div>
      
      <div id="imagePreview" role="region" aria-label="åœ–ç‰‡é è¦½">
        <img id="preview" style="display:none;" alt="é¸æ“‡çš„åœ–ç‰‡é è¦½" />
      </div>
    </div>
    
    <!-- é™¤éŒ¯å€åŸŸ -->
    <div class="section">
      <h3>ğŸ”§ é™¤éŒ¯è³‡è¨Š</h3>
      <p>æŠ€è¡“äººå“¡å¯ä»¥æŸ¥çœ‹è©³ç´°çš„é™¤éŒ¯è³‡è¨Š</p>
      <button onclick="clearDebug()" aria-describedby="clearHelp">æ¸…é™¤é™¤éŒ¯è¨Šæ¯</button>
      <div id="clearHelp" class="sr-only">æ¸…é™¤æ‰€æœ‰é™¤éŒ¯è¨Šæ¯</div>
      <div id="debug" role="log" aria-label="é™¤éŒ¯è¨Šæ¯"></div>
    </div>
  </div>

  <script>
    // é…ç½®å¸¸æ•¸
    const CONFIG = {
      LIFF_ID: "2007733246-nAexA2b9",
      MAX_STATUS_MESSAGES: 5,
      DEBUG_MAX_HEIGHT: 400,
      RETRY_ATTEMPTS: 3,
      RETRY_DELAY: 1000
    };

    // å…¨åŸŸè®Šæ•¸
    let liffReady = false;
    let userProfile = null;
    let initRetryCount = 0;
    
    // å·¥å…·å‡½æ•¸
    function addStatus(message, type = 'info') {
      const container = document.getElementById('status-container');
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = message;
      div.setAttribute('role', 'alert');
      container.appendChild(div);
      
      // è‡ªå‹•ç§»é™¤èˆŠçš„ç‹€æ…‹è¨Šæ¯
      const statuses = container.querySelectorAll('.status');
      if (statuses.length > CONFIG.MAX_STATUS_MESSAGES) {
        container.removeChild(statuses[0]);
      }
      
      // è‡ªå‹•éš±è—æˆåŠŸè¨Šæ¯
      if (type === 'success') {
        setTimeout(() => {
          if (div.parentNode) {
            div.style.opacity = '0';
            setTimeout(() => {
              if (div.parentNode) {
                div.parentNode.removeChild(div);
              }
            }, 300);
          }
        }, 5000);
      }
    }
    
    function addDebug(message) {
      const debug = document.getElementById('debug');
      const time = new Date().toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.innerHTML = `<span style="color: #666;">[${time}]</span> ${message}`;
      debug.appendChild(logEntry);
      debug.scrollTop = debug.scrollHeight;
      console.log(`[LIFF Debug] ${message}`);
    }
    
    function clearDebug() {
      document.getElementById('debug').innerHTML = '';
      addDebug('é™¤éŒ¯è¨Šæ¯å·²æ¸…é™¤');
    }
    
    function showLoading(elementId, show = true) {
      const element = document.getElementById(elementId);
      const textElement = document.getElementById(elementId + 'Text');
      
      if (show) {
        element.disabled = true;
        if (textElement) {
          textElement.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';
        }
      } else {
        element.disabled = false;
        if (textElement) {
          textElement.innerHTML = element.id === 'loginBtn' ? 'ğŸ”‘ ä½¿ç”¨ LINE ç™»å…¥' : 'ğŸ“· é¸æ“‡åœ–ç‰‡';
        }
      }
    }
    
    function updateEnvironmentInfo() {
      const envInfo = document.getElementById('environmentInfo');
      const envDetails = document.getElementById('envDetails');
      
      if (typeof liff !== 'undefined' && liffReady) {
        const isInClient = liff.isInClient();
        const os = liff.getOS();
        const version = liff.getVersion();
        const language = liff.getLanguage();
        
        envDetails.innerHTML = `
          åŸ·è¡Œç’°å¢ƒ: ${isInClient ? 'LINE æ‡‰ç”¨ç¨‹å¼' : 'å¤–éƒ¨ç€è¦½å™¨'} | 
          ä½œæ¥­ç³»çµ±: ${os} | 
          LIFF ç‰ˆæœ¬: ${version} | 
          èªè¨€: ${language}
        `;
        envInfo.classList.remove('hidden');
      }
    }
    
    function updateUI() {
      const loginSection = document.getElementById('loginSection');
      const functionSection = document.getElementById('functionSection');
      const loginBtn = document.getElementById('loginBtn');
      const chooseBtn = document.getElementById('chooseBtn');
      const chooseBtnText = document.getElementById('chooseBtnText');
      const userInfo = document.getElementById('userInfo');
      
      if (typeof liff !== 'undefined' && liff.isLoggedIn() && userProfile) {
        // å·²ç™»å…¥ç‹€æ…‹
        loginBtn.style.display = 'none';
        userInfo.className = '';
        userInfo.innerHTML = `
          <div style="display: flex; align-items: center; margin-bottom: 15px;">
            <img src="${userProfile.pictureUrl}" width="60" height="60" alt="${userProfile.displayName} çš„é ­åƒ" />
            <div>
              <h4 style="margin: 0; color: var(--line-green);">âœ… ç™»å…¥æˆåŠŸ</h4>
              <p style="margin: 5px 0;"><strong>æ­¡è¿ï¼š</strong>${userProfile.displayName}</p>
              <p style="margin: 0; font-size: 0.9em; color: #666;"><strong>ç”¨æˆ¶IDï¼š</strong>${userProfile.userId}</p>
            </div>
          </div>
        `;
        functionSection.classList.remove('hidden');
        chooseBtn.disabled = !liffReady;
        chooseBtnText.textContent = liffReady ? 'ğŸ“· é¸æ“‡åœ–ç‰‡' : 'ç­‰å¾… LIFF åˆå§‹åŒ–...';
        
        updateEnvironmentInfo();
      } else {
        // æœªç™»å…¥ç‹€æ…‹
        loginBtn.style.display = 'inline-block';
        userInfo.classList.add('hidden');
        functionSection.classList.add('hidden');
        chooseBtn.disabled = true;
      }
    }

    async function initializeLiff(retryCount = 0) {
      try {
        addDebug(`ğŸ”„ é–‹å§‹åˆå§‹åŒ– LIFF... (å˜—è©¦ ${retryCount + 1}/${CONFIG.RETRY_ATTEMPTS})`);
        addStatus("æ­£åœ¨åˆå§‹åŒ– LIFF...", "info");
        
        // æª¢æŸ¥ LIFF SDK æ˜¯å¦è¼‰å…¥
        if (typeof liff === 'undefined') {
          throw new Error('LIFF SDK æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š');
        }
        
        addDebug("âœ… LIFF SDK å·²è¼‰å…¥");
        
        // åˆå§‹åŒ– LIFF
        await liff.init({ liffId: CONFIG.LIFF_ID });
        addDebug("âœ… LIFF åˆå§‹åŒ–å®Œæˆ");
        addStatus("LIFF åˆå§‹åŒ–æˆåŠŸ", "success");

        // è¨­å®šç™»å…¥æŒ‰éˆ•äº‹ä»¶
        document.getElementById('loginBtn').onclick = async () => {
          try {
            addDebug("ğŸ”„ é–‹å§‹ LINE ç™»å…¥æµç¨‹...");
            addStatus("æ­£åœ¨è·³è½‰åˆ° LINE ç™»å…¥é é¢...", "info");
            showLoading('loginBtn', true);
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ LINE å®¢æˆ¶ç«¯ä¸­
            if (!liff.isInClient()) {
              addStatus("å»ºè­°åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿä»¥ç²å¾—æœ€ä½³ç™»å…¥é«”é©—", "warning");
            }
            
            liff.login();
          } catch (error) {
            addDebug(`âŒ ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
            addStatus("ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦", "error");
            showLoading('loginBtn', false);
          }
        };

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        if (!liff.isLoggedIn()) {
          addDebug("ğŸ”’ å°šæœªç™»å…¥ LINE");
          addStatus("è«‹é»æ“ŠæŒ‰éˆ•ç™»å…¥ LINE å¸³è™Ÿ", "warning");
        } else {
          addDebug("âœ… å·²ç™»å…¥ LIFF");
          addStatus("å·²ç™»å…¥ LINE å¸³è™Ÿ", "success");
          
          // ç²å–ç”¨æˆ¶è³‡è¨Š
          try {
            userProfile = await liff.getProfile();
            addDebug(`ğŸ‘¤ ç”¨æˆ¶è³‡è¨Š: ${userProfile.displayName} (${userProfile.userId})`);
            addStatus(`æ­¡è¿ ${userProfile.displayName}ï¼`, "success");
          } catch (err) {
            addDebug(`âš ï¸ ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Š: ${err.message}`);
            addStatus("ç„¡æ³•ç²å–ç”¨æˆ¶è³‡è¨Šï¼Œä½†å¯ä»¥ç¹¼çºŒä½¿ç”¨", "warning");
          }
        }
        
        // æª¢æŸ¥åŠŸèƒ½æ”¯æ´
        const features = {
          chooseMedia: typeof liff.chooseMedia === 'function',
          shareTargetPicker: typeof liff.shareTargetPicker === 'function',
          scanCode: typeof liff.scanCode === 'function'
        };
        
        addDebug(`ğŸ“‹ åŠŸèƒ½æ”¯æ´æª¢æŸ¥: ${JSON.stringify(features)}`);
        
        if (!features.chooseMedia) {
          throw new Error('æ­¤ç‰ˆæœ¬çš„ LIFF ä¸æ”¯æ´ chooseMedia åŠŸèƒ½');
        }
        
        addDebug("âœ… chooseMedia åŠŸèƒ½å¯ç”¨");
        
        // æª¢æŸ¥åŸ·è¡Œç’°å¢ƒ
        const isInClient = liff.isInClient();
        addDebug(`ğŸ“± åŸ·è¡Œç’°å¢ƒ: ${isInClient ? 'LINE æ‡‰ç”¨ç¨‹å¼å…§' : 'å¤–éƒ¨ç€è¦½å™¨'}`);
        
        if (!isInClient) {
          addStatus("å»ºè­°åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿä»¥ç²å¾—å®Œæ•´åŠŸèƒ½", "warning");
        }
        
        liffReady = true;
        updateUI();
        
        if (liff.isLoggedIn()) {
          addStatus("LIFF æº–å‚™å°±ç·’ï¼Œå¯ä»¥é¸æ“‡åœ–ç‰‡", "success");
        }
        
        // é‡ç½®é‡è©¦è¨ˆæ•¸
        initRetryCount = 0;
        
      } catch (err) {
        addDebug(`âŒ LIFF åˆå§‹åŒ–éŒ¯èª¤: ${err.message}`);
        
        if (retryCount < CONFIG.RETRY_ATTEMPTS - 1) {
          addStatus(`åˆå§‹åŒ–å¤±æ•—ï¼Œ${CONFIG.RETRY_DELAY/1000} ç§’å¾Œé‡è©¦...`, "warning");
          setTimeout(() => {
            initializeLiff(retryCount + 1);
          }, CONFIG.RETRY_DELAY);
        } else {
          addStatus(`åˆå§‹åŒ–å¤±æ•—: ${err.message}`, "error");
          addStatus("è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–é‡æ–°æ•´ç†é é¢", "error");
        }
        
        console.error("LIFF åˆå§‹åŒ–éŒ¯èª¤", err);
      }
    }

    async function chooseMedia() {
      if (!liffReady) {
        addStatus("LIFF å°šæœªæº–å‚™å°±ç·’", "error");
        return;
      }
      
      if (!liff.isLoggedIn()) {
        addStatus("è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿ", "error");
        return;
      }
      
      try {
        addDebug("ğŸ–¼ï¸ é–‹å§‹é¸æ“‡åœ–ç‰‡...");
        addStatus("æ­£åœ¨é–‹å•Ÿåœ–ç‰‡é¸æ“‡å™¨...", "info");
        showLoading('chooseBtn', true);
        
        // æª¢æŸ¥æ˜¯å¦åœ¨ LINE å®¢æˆ¶ç«¯ä¸­
        if (!liff.isInClient()) {
          addStatus("åœ–ç‰‡é¸æ“‡åŠŸèƒ½éœ€è¦åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨", "warning");
          showLoading('chooseBtn', false);
          return;
        }
        
        const result = await liff.chooseMedia({
          count: 1,
          mediaType: 'image',
          source: ['camera', 'gallery']
        });

        addDebug(`ğŸ“‚ é¸æ“‡çµæœ: ${JSON.stringify({
          mediaCount: result?.media?.length || 0,
          hasResult: !!result
        })}`);

        if (result && result.media && result.media.length > 0) {
          const mediaItem = result.media[0];
          addDebug(`ğŸ“· åœ–ç‰‡è³‡è¨Š: å¤§å°=${mediaItem.blob.size} bytes, é¡å‹=${mediaItem.blob.type}`);
          
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = document.getElementById("preview");
            img.src = e.target.result;
            img.style.display = "block";
            img.alt = `é¸æ“‡çš„åœ–ç‰‡ - ${mediaItem.blob.type}, ${(mediaItem.blob.size/1024).toFixed(1)}KB`;
            addStatus("åœ–ç‰‡è¼‰å…¥æˆåŠŸ", "success");
            addDebug("âœ… åœ–ç‰‡é è¦½å·²é¡¯ç¤º");
          };
          
          reader.onerror = function() {
            addStatus("åœ–ç‰‡è®€å–å¤±æ•—", "error");
            addDebug("âŒ FileReader éŒ¯èª¤");
          };
          
          reader.readAsDataURL(mediaItem.blob);
        } else {
          addStatus("æœªé¸æ“‡ä»»ä½•åœ–ç‰‡", "warning");
          addDebug("âš ï¸ æ²’æœ‰é¸æ“‡åœ–ç‰‡æˆ–çµæœç‚ºç©º");
        }
      } catch (err) {
        addDebug(`âŒ é¸æ“‡åœ–ç‰‡å¤±æ•—: ${err.message}`);
        addStatus(`é¸æ“‡åœ–ç‰‡å¤±æ•—: ${err.message}`, "error");
        console.error("é¸æ“‡åœ–ç‰‡å¤±æ•—", err);
        
        // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è³‡è¨Šå’Œå»ºè­°
        if (err.message.includes('Permission')) {
          addStatus("è«‹æª¢æŸ¥ç›¸æ©Ÿå’Œå„²å­˜æ¬Šé™è¨­å®š", "warning");
        } else if (err.message.includes('not supported')) {
          addStatus("æ‚¨çš„è£ç½®æˆ–ç€è¦½å™¨ä¸æ”¯æ´æ­¤åŠŸèƒ½", "warning");
        } else if (err.message.includes('cancelled')) {
          addStatus("ç”¨æˆ¶å–æ¶ˆäº†åœ–ç‰‡é¸æ“‡", "info");
        }
      } finally {
        showLoading('chooseBtn', false);
      }
    }
    
    function logout() {
      if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
        try {
          liff.logout();
          userProfile = null;
          liffReady = false;
          addDebug("ğŸ”“ å·²ç™»å‡º LINE");
          addStatus("å·²ç™»å‡º LINE å¸³è™Ÿ", "info");
          updateUI();
          
          // æ¸…é™¤åœ–ç‰‡é è¦½
          const preview = document.getElementById('preview');
          preview.style.display = 'none';
          preview.src = '';
          
          // éš±è—ç’°å¢ƒè³‡è¨Š
          document.getElementById('environmentInfo').classList.add('hidden');
          
        } catch (error) {
          addDebug(`âŒ ç™»å‡ºéç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`);
          addStatus("ç™»å‡ºæ™‚ç™¼ç”ŸéŒ¯èª¤", "error");
        }
      }
    }
    
    function checkLiffStatus() {
      addDebug("ğŸ” æª¢æŸ¥ LIFF ç‹€æ…‹...");
      
      if (typeof liff === 'undefined') {
        addStatus("LIFF SDK æœªè¼‰å…¥", "error");
        return;
      }
      
      try {
        const status = {
          ready: liffReady,
          loggedIn: liff.isLoggedIn ? liff.isLoggedIn() : false,
          inClient: liff.isInClient ? liff.isInClient() : false,
          os: liff.getOS ? liff.getOS() : 'unknown',
          version: liff.getVersion ? liff.getVersion() : 'unknown',
          language: liff.getLanguage ? liff.getLanguage() : 'unknown',
          features: {
            chooseMedia: typeof liff.chooseMedia === 'function',
            shareTargetPicker: typeof liff.shareTargetPicker === 'function',
            scanCode: typeof liff.scanCode === 'function'
          },
          userProfile: userProfile ? {
            displayName: userProfile.displayName,
            userId: userProfile.userId.substring(0, 8) + '...' // éš±ç§ä¿è­·
          } : null
        };
        
        addDebug(`ğŸ“Š LIFF å®Œæ•´ç‹€æ…‹:`);
        Object.entries(status).forEach(([key, value]) => {
          if (typeof value === 'object') {
            addDebug(`  ${key}: ${JSON.stringify(value, null, 2)}`);
          } else {
            const statusText = value ? 'âœ…' : 'âŒ';
            addDebug(`  ${statusText} ${key}: ${value}`);
          }
        });
        
        addStatus("LIFF ç‹€æ…‹å·²è¼¸å‡ºåˆ°é™¤éŒ¯å€åŸŸ", "info");
        
      } catch (error) {
        addDebug(`âŒ ç‹€æ…‹æª¢æŸ¥å¤±æ•—: ${error.message}`);
        addStatus("ç‹€æ…‹æª¢æŸ¥å¤±æ•—", "error");
      }
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    window.addEventListener('load', () => {
      addDebug("ğŸš€ é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...");
      initializeLiff();
    });
    
    // éŒ¯èª¤è™•ç†
    window.addEventListener('error', (event) => {
      addDebug(`âŒ å…¨åŸŸéŒ¯èª¤: ${event.error?.message || event.message}`);
      console.error('Global error:', event.error);
    });
    
    // æœªè™•ç†çš„ Promise æ‹’çµ•
    window.addEventListener('unhandledrejection', (event) => {
      addDebug(`âŒ æœªè™•ç†çš„ Promise æ‹’çµ•: ${event.reason}`);
      console.error('Unhandled promise rejection:', event.reason);
    });
  </script>
</body>
</html>
